<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Dashboard - Medicare+</title>
    <link rel="stylesheet" href="../css/provider-dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.8.0/Recharts.js"></script>
    <style>
        /* Mobile-first responsive design */
        * { box-sizing: border-box; }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            background: #f8fafc;
        }
        
        @media (max-width: 768px) {
            .dashboard-container { 
                flex-direction: column; 
                padding: 0; 
            }
            .sidebar { 
                width: 100%; 
                height: auto; 
                position: relative;
                order: 2;
                display: none;
            }
            .sidebar.mobile-open { 
                display: block; 
                position: fixed; 
                top: 0; 
                left: 0; 
                right: 0; 
                bottom: 0; 
                z-index: 1000; 
                background: white;
            }
            .main-content { 
                width: 100%; 
                margin-left: 0;
                order: 1;
                padding: 10px;
            }
            .dashboard-grid { 
                grid-template-columns: 1fr; 
                gap: 15px; 
            }
            .card { 
                margin: 10px 0; 
            }
            .nav-item {
                padding: 15px 20px;
                font-size: 16px;
                border-bottom: 1px solid #e2e8f0;
            }
            .mobile-menu-toggle {
                display: block !important;
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1001;
                background: #3b82f6;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .patient-card, .appointment-card {
                padding: 15px;
                margin: 10px 0;
            }
            .form-row {
                flex-direction: column;
            }
            .form-row input, .form-row select {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none !important;
            }
            .sidebar {
                width: 280px;
                position: fixed;
                height: 100vh;
                overflow-y: auto;
            }
            .main-content {
                margin-left: 280px;
                width: calc(100% - 280px);
                padding: 20px;
            }
        }
        
        /* Loading and error states */
        .loading { 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 200px; 
        }
        .spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error-message { 
            background: #fef2f2; 
            color: #dc2626; 
            padding: 12px 15px; 
            border-radius: 8px; 
            margin: 10px 0;
            border: 1px solid #fecaca;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .success-message { 
            background: #f0fdf4; 
            color: #166534; 
            padding: 12px 15px; 
            border-radius: 8px; 
            margin: 10px 0;
            border: 1px solid #bbf7d0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3b82f6;
            margin: 10px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .empty-state i {
            color: #d1d5db;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .patient-card, .appointment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status.active { background: #dcfce7; color: #166534; }
        .status.scheduled { background: #dbeafe; color: #1e40af; }
        .status.completed { background: #f3e8ff; color: #7c3aed; }
        .status.cancelled { background: #fef2f2; color: #dc2626; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useCallback } = React;

        // Supabase configuration
        const supabaseUrl = 'https://gcggnrwqilylyykppizb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjaGducndxaWx5bHl5a3BwaXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTIyNDI1MzgsImV4cCI6MjAyNzgxODUzOH0.GtHQVOl7NSmNWE6u6wqYSN8EZwrBw4yyJ5fK4Lr0n2k';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Contexts
        const AuthContext = createContext();
        const ProviderDataContext = createContext();

        // Authentication Provider
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setUser(session?.user ?? null);
                    setLoading(false);
                }).catch(err => {
                    console.error('Auth error:', err);
                    setError('Authentication failed');
                    setLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    setUser(session?.user ?? null);
                    setError(null);
                    setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            const signIn = async (email, password) => {
                try {
                    setError(null);
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) setError(error.message);
                    return { data, error };
                } catch (err) {
                    setError('Sign in failed');
                    return { data: null, error: err };
                }
            };

            const signOut = async () => {
                try {
                    setError(null);
                    const { error } = await supabase.auth.signOut();
                    if (error) setError(error.message);
                    return { error };
                } catch (err) {
                    setError('Sign out failed');
                    return { error: err };
                }
            };

            return (
                <AuthContext.Provider value={{
                    user, session, loading, error, signIn, signOut,
                    clearError: () => setError(null)
                }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // Provider Data Provider
        const ProviderDataProvider = ({ children }) => {
            const { user } = useContext(AuthContext);
            const [data, setData] = useState({
                patients: [],
                appointments: [],
                medications: [],
                analytics: null
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleError = (error, context) => {
                console.error(`${context}:`, error);
                setError(`${context}: ${error.message || 'Unknown error'}`);
            };

            // Fetch patients with error handling
            const fetchPatients = useCallback(async () => {
                if (!user) return;
                
                try {
                    setError(null);
                    // Simplified query - just get user profiles for now
                    const { data: profiles, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .limit(50);
                    
                    if (error) throw error;
                    setData(prev => ({ ...prev, patients: profiles || [] }));
                } catch (error) {
                    handleError(error, 'Patients loading');
                    setData(prev => ({ ...prev, patients: [] }));
                }
            }, [user]);

            // Fetch appointments
            const fetchAppointments = useCallback(async () => {
                if (!user) return;
                
                try {
                    setError(null);
                    const { data: appointments, error } = await supabase
                        .from('appointments')
                        .select('*')
                        .eq('provider_id', user.id)
                        .order('scheduled_date', { ascending: true })
                        .limit(100);
                    
                    if (error) throw error;
                    setData(prev => ({ ...prev, appointments: appointments || [] }));
                } catch (error) {
                    handleError(error, 'Appointments loading');
                    setData(prev => ({ ...prev, appointments: [] }));
                }
            }, [user]);

            // Fetch medications
            const fetchMedications = useCallback(async () => {
                if (!user) return;
                
                try {
                    setError(null);
                    const { data: medications, error } = await supabase
                        .from('patient_medications')
                        .select('*, medications(*)')
                        .eq('prescribed_by', user.id)
                        .order('created_at', { ascending: false })
                        .limit(100);
                    
                    if (error) throw error;
                    setData(prev => ({ ...prev, medications: medications || [] }));
                } catch (error) {
                    handleError(error, 'Medications loading');
                    setData(prev => ({ ...prev, medications: [] }));
                }
            }, [user]);

            // Create appointment
            const createAppointment = async (appointmentData) => {
                if (!user) return { success: false, error: 'Not authenticated' };
                
                try {
                    setError(null);
                    const { data, error } = await supabase
                        .from('appointments')
                        .insert([{
                            ...appointmentData,
                            provider_id: user.id,
                            status: 'scheduled'
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    await fetchAppointments();
                    return { success: true, data };
                } catch (error) {
                    handleError(error, 'Creating appointment');
                    return { success: false, error: error.message };
                }
            };

            // Update appointment
            const updateAppointment = async (appointmentId, updates) => {
                try {
                    setError(null);
                    const { data, error } = await supabase
                        .from('appointments')
                        .update(updates)
                        .eq('id', appointmentId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    await fetchAppointments();
                    return { success: true, data };
                } catch (error) {
                    handleError(error, 'Updating appointment');
                    return { success: false, error: error.message };
                }
            };

            // Prescribe medication
            const prescribeMedication = async (patientId, medicationData) => {
                if (!user) return { success: false, error: 'Not authenticated' };
                
                try {
                    setError(null);
                    const { data, error } = await supabase
                        .from('patient_medications')
                        .insert([{
                            ...medicationData,
                            user_id: patientId,
                            prescribed_by: user.id,
                            status: 'active'
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    await fetchMedications();
                    return { success: true, data };
                } catch (error) {
                    handleError(error, 'Prescribing medication');
                    return { success: false, error: error.message };
                }
            };

            // Initialize data
            useEffect(() => {
                if (user) {
                    setLoading(true);
                    Promise.all([
                        fetchPatients(),
                        fetchAppointments(),
                        fetchMedications()
                    ]).finally(() => {
                        setLoading(false);
                    });
                }
            }, [user, fetchPatients, fetchAppointments, fetchMedications]);

            return (
                <ProviderDataContext.Provider value={{
                    data, loading, error,
                    createAppointment, updateAppointment, prescribeMedication,
                    fetchPatients, fetchAppointments, fetchMedications,
                    clearError: () => setError(null)
                }}>
                    {children}
                </ProviderDataContext.Provider>
            );
        };

        // Login Component
        const ProviderLogin = () => {
            const [credentials, setCredentials] = useState({ email: '', password: '' });
            const [loading, setLoading] = useState(false);
            const [localError, setLocalError] = useState('');
            const { signIn, error, clearError } = useContext(AuthContext);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setLocalError('');
                clearError();

                try {
                    const result = await signIn(credentials.email, credentials.password);
                    if (result.error) {
                        setLocalError(result.error.message);
                    }
                } catch (err) {
                    setLocalError('Login failed');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#f8fafc' }}>
                    <div className="login-card" style={{ background: 'white', padding: '40px', borderRadius: '12px', boxShadow: '0 4px 20px rgba(0,0,0,0.1)', maxWidth: '400px', width: '100%', margin: '20px' }}>
                        <div className="login-header" style={{ textAlign: 'center', marginBottom: '30px' }}>
                            <h1 style={{ color: '#1f2937', marginBottom: '10px' }}>üè• Medicare+ Provider</h1>
                            <p style={{ color: '#6b7280' }}>Healthcare Provider Dashboard</p>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Email</label>
                                <input
                                    type="email"
                                    value={credentials.email}
                                    onChange={(e) => setCredentials(prev => ({ ...prev, email: e.target.value }))}
                                    required
                                    placeholder="Enter your email"
                                    style={{ width: '100%', padding: '12px', border: '1px solid #d1d5db', borderRadius: '8px' }}
                                />
                            </div>
                            
                            <div className="form-group" style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Password</label>
                                <input
                                    type="password"
                                    value={credentials.password}
                                    onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}
                                    required
                                    placeholder="Enter your password"
                                    style={{ width: '100%', padding: '12px', border: '1px solid #d1d5db', borderRadius: '8px' }}
                                />
                            </div>
                            
                            {(error || localError) && (
                                <div className="error-message">
                                    {error || localError}
                                </div>
                            )}
                            
                            <button type="submit" disabled={loading} className="btn-primary" style={{ width: '100%', padding: '12px', fontSize: '16px' }}>
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>

                        <div style={{ marginTop: '20px', padding: '15px', background: '#f8fafc', borderRadius: '8px' }}>
                            <h4 style={{ margin: '0 0 10px 0', fontSize: '14px' }}>Demo Account</h4>
                            <p style={{ margin: '0', fontSize: '13px', color: '#6b7280' }}>
                                <strong>Email:</strong> doctor@demo.com<br/>
                                <strong>Password:</strong> password123
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Navigation Component
        const Navigation = ({ activeTab, setActiveTab, onClose }) => {
            const { signOut } = useContext(AuthContext);

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-chart-line' },
                { id: 'patients', label: 'Patients', icon: 'fas fa-users' },
                { id: 'appointments', label: 'Appointments', icon: 'fas fa-calendar-alt' },
                { id: 'medications', label: 'Prescriptions', icon: 'fas fa-prescription-bottle-alt' },
                { id: 'analytics', label: 'Analytics', icon: 'fas fa-chart-bar' }
            ];

            return (
                <nav className="sidebar" style={{ background: 'white', borderRight: '1px solid #e2e8f0', padding: '20px 0' }}>
                    <div style={{ padding: '0 20px 20px 20px', borderBottom: '1px solid #e2e8f0' }}>
                        <h2 style={{ color: '#1f2937', margin: 0 }}>Medicare+ Provider</h2>
                        {onClose && (
                            <button onClick={onClose} style={{ float: 'right', background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer' }}>
                                ‚úï
                            </button>
                        )}
                    </div>
                    
                    <ul style={{ listStyle: 'none', padding: 0, margin: '20px 0' }}>
                        {navItems.map(item => (
                            <li key={item.id}>
                                <button
                                    className={`nav-item ${activeTab === item.id ? 'active' : ''}`}
                                    onClick={() => {
                                        setActiveTab(item.id);
                                        onClose && onClose();
                                    }}
                                    style={{
                                        width: '100%',
                                        padding: '12px 20px',
                                        border: 'none',
                                        background: activeTab === item.id ? '#eff6ff' : 'transparent',
                                        color: activeTab === item.id ? '#3b82f6' : '#6b7280',
                                        textAlign: 'left',
                                        cursor: 'pointer',
                                        borderLeft: activeTab === item.id ? '3px solid #3b82f6' : '3px solid transparent',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <i className={item.icon} style={{ marginRight: '10px' }}></i>
                                    <span>{item.label}</span>
                                </button>
                            </li>
                        ))}
                    </ul>
                    
                    <div style={{ padding: '20px', borderTop: '1px solid #e2e8f0', marginTop: 'auto' }}>
                        <button onClick={signOut} className="btn-primary" style={{ width: '100%' }}>
                            <i className="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </nav>
            );
        };

        // Header Component
        const Header = ({ user }) => (
            <header style={{ background: 'white', padding: '20px', borderBottom: '1px solid #e2e8f0', marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h1 style={{ margin: 0, color: '#1f2937' }}>Provider Dashboard</h1>
                    <div style={{ color: '#6b7280' }}>
                        Welcome, Dr. {user?.email?.split('@')[0] || 'Provider'}
                    </div>
                </div>
            </header>
        );

        // Main Dashboard Component
        const Dashboard = () => {
            const { user } = useContext(AuthContext);
            const { data, loading, error, clearError } = useContext(ProviderDataContext);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            if (!user) {
                return <ProviderLogin />;
            }

            return (
                                 <div className="dashboard-container">
                     <button 
                         className="mobile-menu-toggle"
                         onClick={() => setIsMobileMenuOpen(true)}
                     >
                         <i className="fas fa-bars"></i> Menu
                     </button>

                     <div className={`sidebar ${isMobileMenuOpen ? 'mobile-open' : ''}`}>
                         <Navigation 
                             activeTab={activeTab} 
                             setActiveTab={setActiveTab}
                             onClose={() => setIsMobileMenuOpen(false)}
                         />
                     </div>
                     
                     <main className="main-content">
                         <Header user={user} />
                         
                         {error && (
                             <div className="error-message">
                                 {error}
                                 <button onClick={clearError}>‚úï</button>
                             </div>
                         )}
                         
                         {loading ? (
                             <div className="loading">
                                 <div className="spinner"></div>
                                 <p>Loading dashboard data...</p>
                             </div>
                         ) : (
                             <DashboardContent activeTab={activeTab} data={data} />
                         )}
                     </main>
                 </div>
            );
        };

        // Dashboard Content
        const DashboardContent = ({ activeTab, data }) => {
            switch (activeTab) {
                case 'dashboard':
                    return <OverviewTab data={data} />;
                case 'patients':
                    return <PatientsTab patients={data.patients} />;
                case 'appointments':
                    return <AppointmentsTab appointments={data.appointments} />;
                case 'medications':
                    return <MedicationsTab medications={data.medications} />;
                case 'analytics':
                    return <AnalyticsTab data={data} />;
                default:
                    return <OverviewTab data={data} />;
            }
        };

        // Overview Tab
        const OverviewTab = ({ data }) => (
            <div>
                <h2>Dashboard Overview</h2>
                <div className="dashboard-grid">
                    <div className="card">
                        <h3><i className="fas fa-users"></i> Total Patients</h3>
                        <div className="stat-number">{data.patients?.length || 0}</div>
                        <p>Registered patients</p>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-calendar"></i> Today's Appointments</h3>
                        <div className="stat-number">
                            {data.appointments?.filter(apt => 
                                new Date(apt.scheduled_date).toDateString() === new Date().toDateString()
                            ).length || 0}
                        </div>
                        <p>Scheduled for today</p>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-prescription-bottle-alt"></i> Active Prescriptions</h3>
                        <div className="stat-number">{data.medications?.length || 0}</div>
                        <p>Currently prescribed</p>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-clock"></i> Pending Appointments</h3>
                        <div className="stat-number">
                            {data.appointments?.filter(apt => apt.status === 'scheduled').length || 0}
                        </div>
                        <p>Awaiting confirmation</p>
                    </div>
                </div>

                <div className="card" style={{ marginTop: '20px' }}>
                    <h3>Recent Activity</h3>
                    <div style={{ color: '#6b7280' }}>
                        <p>‚Ä¢ {data.appointments?.length || 0} appointments in system</p>
                        <p>‚Ä¢ {data.medications?.length || 0} medications prescribed</p>
                        <p>‚Ä¢ {data.patients?.length || 0} patients registered</p>
                    </div>
                </div>
            </div>
        );

        // Patients Tab
        const PatientsTab = ({ patients = [] }) => (
            <div>
                <h2>Patient Management</h2>
                {patients.length === 0 ? (
                    <div className="empty-state">
                        <i className="fas fa-users fa-3x"></i>
                        <h3>No patients found</h3>
                        <p>Patients will appear here when they register with the system</p>
                    </div>
                ) : (
                    <div>
                        {patients.map(patient => (
                            <div key={patient.id} className="patient-card">
                                <h4>{patient.first_name || 'Patient'} {patient.last_name || 'User'}</h4>
                                <p><strong>Email:</strong> {patient.email || 'N/A'}</p>
                                {patient.phone && <p><strong>Phone:</strong> {patient.phone}</p>}
                                {patient.date_of_birth && <p><strong>DOB:</strong> {patient.date_of_birth}</p>}
                                <div style={{ marginTop: '10px' }}>
                                    <button className="btn-primary" style={{ marginRight: '10px' }}>
                                        View Details
                                    </button>
                                    <button className="btn-primary">
                                        Schedule Appointment
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // Appointments Tab
        const AppointmentsTab = ({ appointments = [] }) => {
            const { createAppointment } = useContext(ProviderDataContext);
            const [showNewForm, setShowNewForm] = useState(false);
            const [newAppointment, setNewAppointment] = useState({
                user_id: '',
                scheduled_date: '',
                appointment_type: 'consultation',
                notes: ''
            });
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);

                try {
                    const result = await createAppointment(newAppointment);
                    if (result.success) {
                        setMessage('Appointment created successfully!');
                        setShowNewForm(false);
                        setNewAppointment({
                            user_id: '',
                            scheduled_date: '',
                            appointment_type: 'consultation',
                            notes: ''
                        });
                    } else {
                        setMessage(`Error: ${result.error}`);
                    }
                } catch (error) {
                    setMessage('Failed to create appointment');
                } finally {
                    setSaving(false);
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <h2>Appointments</h2>
                        <button 
                            className="btn-primary"
                            onClick={() => setShowNewForm(!showNewForm)}
                        >
                            <i className="fas fa-plus"></i> New Appointment
                        </button>
                    </div>

                    {message && (
                        <div className={message.includes('Error') ? 'error-message' : 'success-message'}>
                            {message}
                        </div>
                    )}

                    {showNewForm && (
                        <div className="card" style={{ marginBottom: '20px' }}>
                            <h3>Schedule New Appointment</h3>
                            <form onSubmit={handleSubmit}>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Patient ID</label>
                                        <input
                                            type="text"
                                            value={newAppointment.user_id}
                                            onChange={(e) => setNewAppointment(prev => ({ ...prev, user_id: e.target.value }))}
                                            required
                                            placeholder="Enter patient ID"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Date & Time</label>
                                        <input
                                            type="datetime-local"
                                            value={newAppointment.scheduled_date}
                                            onChange={(e) => setNewAppointment(prev => ({ ...prev, scheduled_date: e.target.value }))}
                                            required
                                        />
                                    </div>
                                </div>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Appointment Type</label>
                                        <select
                                            value={newAppointment.appointment_type}
                                            onChange={(e) => setNewAppointment(prev => ({ ...prev, appointment_type: e.target.value }))}
                                        >
                                            <option value="consultation">Consultation</option>
                                            <option value="follow_up">Follow-up</option>
                                            <option value="procedure">Procedure</option>
                                            <option value="screening">Screening</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Notes</label>
                                        <textarea
                                            value={newAppointment.notes}
                                            onChange={(e) => setNewAppointment(prev => ({ ...prev, notes: e.target.value }))}
                                            placeholder="Appointment notes..."
                                            rows="3"
                                        />
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button type="submit" disabled={saving} className="btn-primary">
                                        {saving ? 'Creating...' : 'Create Appointment'}
                                    </button>
                                    <button 
                                        type="button" 
                                        onClick={() => setShowNewForm(false)}
                                        style={{ background: '#6b7280' }}
                                        className="btn-primary"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {appointments.length === 0 ? (
                        <div className="empty-state">
                            <i className="fas fa-calendar fa-3x"></i>
                            <h3>No appointments scheduled</h3>
                            <p>Appointments will appear here when scheduled</p>
                        </div>
                    ) : (
                        <div>
                            {appointments.map(appointment => (
                                <div key={appointment.id} className="appointment-card">
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <h4>{appointment.appointment_type || 'Consultation'}</h4>
                                            <p><strong>Date:</strong> {new Date(appointment.scheduled_date).toLocaleString()}</p>
                                            <p><strong>Patient ID:</strong> {appointment.user_id}</p>
                                            {appointment.notes && <p><strong>Notes:</strong> {appointment.notes}</p>}
                                        </div>
                                        <div>
                                            <span className={`status ${appointment.status}`}>
                                                {appointment.status}
                                            </span>
                                        </div>
                                    </div>
                                    <div style={{ marginTop: '10px' }}>
                                        <button className="btn-primary" style={{ marginRight: '10px' }}>
                                            Edit
                                        </button>
                                        <button className="btn-primary" style={{ background: '#10b981' }}>
                                            Complete
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Medications Tab
        const MedicationsTab = ({ medications = [] }) => (
            <div>
                <h2>Prescriptions</h2>
                {medications.length === 0 ? (
                    <div className="empty-state">
                        <i className="fas fa-prescription-bottle-alt fa-3x"></i>
                        <h3>No prescriptions found</h3>
                        <p>Prescribed medications will appear here</p>
                    </div>
                ) : (
                    <div>
                        {medications.map(med => (
                            <div key={med.id} className="card" style={{ marginBottom: '15px' }}>
                                <h4>{med.medications?.name || 'Unknown Medication'}</h4>
                                <p><strong>Patient ID:</strong> {med.user_id}</p>
                                <p><strong>Dosage:</strong> {med.dosage}</p>
                                <p><strong>Frequency:</strong> {med.frequency}</p>
                                <p><strong>Status:</strong> <span className={`status ${med.status}`}>{med.status}</span></p>
                                {med.notes && <p><strong>Notes:</strong> {med.notes}</p>}
                                <p><strong>Prescribed:</strong> {new Date(med.created_at).toLocaleDateString()}</p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // Analytics Tab
        const AnalyticsTab = ({ data }) => (
            <div>
                <h2>Analytics & Reports</h2>
                <div className="dashboard-grid">
                    <div className="card">
                        <h3>Patient Statistics</h3>
                        <p>Total Patients: {data.patients?.length || 0}</p>
                        <p>Active Patients: {data.patients?.length || 0}</p>
                    </div>
                    <div className="card">
                        <h3>Appointment Statistics</h3>
                        <p>Total Appointments: {data.appointments?.length || 0}</p>
                        <p>Completed: {data.appointments?.filter(a => a.status === 'completed').length || 0}</p>
                        <p>Scheduled: {data.appointments?.filter(a => a.status === 'scheduled').length || 0}</p>
                    </div>
                    <div className="card">
                        <h3>Prescription Statistics</h3>
                        <p>Total Prescriptions: {data.medications?.length || 0}</p>
                        <p>Active: {data.medications?.filter(m => m.status === 'active').length || 0}</p>
                    </div>
                </div>
            </div>
        );

        // Main App
        const App = () => (
            <AuthProvider>
                <ProviderDataProvider>
                    <Dashboard />
                </ProviderDataProvider>
            </AuthProvider>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
